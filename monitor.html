<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>System Monitor (MQTT)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    html,body{height:100%}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  </style>
</head>
<body class="min-h-full bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-screen-2xl mx-auto px-4 md:px-6 lg:px-8 py-3">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <div class="flex items-center gap-3">
          <h1 class="text-lg md:text-xl font-semibold">System Monitor（MQTT 即時）</h1>
          <span id="connBadge" class="text-xs px-2 py-1 rounded-full border border-slate-200 bg-slate-50">Connecting…</span>
        </div>
        <div class="text-xs md:text-sm text-slate-600 flex flex-wrap gap-x-3 gap-y-1">
          <span>Broker：
            <code id="wsShown" class="bg-slate-100 px-1 rounded"></code>
          </span>
          <span>Topic：<code class="bg-slate-100 px-1 rounded">sys/agents/+/metrics</code></span>
          <span>User：<code class="bg-slate-100 px-1 rounded">mqtter</code>／Pass：<code class="bg-slate-100 px-1 rounded">••••••••</code></span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-screen-2xl mx-auto px-4 md:px-6 lg:px-8 py-5">
    <!-- 自適應網格 -->
    <div id="grid" class="grid gap-5 [grid-template-columns:repeat(auto-fit,minmax(340px,1fr))]"></div>
    <p class="mt-6 text-xs md:text-sm text-slate-500">⏱️ 每秒更新；磁碟/網路 I/O 以上一筆差值換算。</p>
  </main>

  <script>
    // ===== 可調參數 =====
    const WS_HOST = "ws://192.168.5.33:8081";
    const WS_PATH = ""; // 若 broker 需要，改成 "/mqtt"
    const USERNAME = "mqtter";
    const PASSWORD = "seven777";
    const TOPIC    = "sys/agents/+/metrics";

    // ===== 連線狀態 UI =====
    const connBadge = document.getElementById("connBadge");
    const wsShown   = document.getElementById("wsShown");
    wsShown.textContent = WS_HOST + WS_PATH;

    function setConn(state, msg){
      if(state === "ok"){
        connBadge.textContent = "Connected";
        connBadge.className = "text-xs px-2 py-1 rounded-full border border-emerald-200 bg-emerald-50 text-emerald-700";
      }else if(state === "re"){
        connBadge.textContent = "Reconnecting…";
        connBadge.className = "text-xs px-2 py-1 rounded-full border border-amber-200 bg-amber-50 text-amber-700";
      }else{
        connBadge.textContent = msg || "Error";
        connBadge.className = "text-xs px-2 py-1 rounded-full border border-rose-200 bg-rose-50 text-rose-700";
      }
    }

    // ===== MQTT 連線 =====
    const clientId = "webui-" + Math.random().toString(16).slice(2,10); // 固定一個 tab 的 clientId
    const client = mqtt.connect(WS_HOST + WS_PATH, {
      clientId,
      clean: true,
      username: USERNAME,
      password: PASSWORD,
      protocolVersion: 4,
      keepalive: 30,
      reconnectPeriod: 3000,
      connectTimeout: 8000,
      resubscribe: true, // 自動重新訂閱
    });

    client.on("connect", () => {
      setConn("ok");
      client.subscribe(TOPIC, (err)=> { if (err) console.error("subscribe error:", err); });
    });
    client.on("reconnect", ()=> setConn("re"));
    client.on("offline",  ()=> setConn("re"));
    client.on("end",      ()=> setConn("err","Ended"));
    client.on("error",    (e)=> { console.error("MQTT error:", e); setConn("err", "Error"); });

    // ===== DOM 管理 =====
    const grid  = document.getElementById("grid");
    const cards = new Map();   // host -> refs
    const latestByHost = new Map(); // host -> last payload (for batch render)

function ensureCard(host){
    // 先嘗試拿既有的
    let ui = cards.get(host);
    if (ui) return ui;

    const card = document.createElement("section");
    card.className = "rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden";

    const header = document.createElement("div");
    header.className = "px-4 py-3 border-b border-slate-200 flex items-center justify-between gap-2";
    header.innerHTML = `
      <div class="min-w-0">
        <h3 class="text-base font-semibold truncate flex items-center gap-2">
          <span class="host"></span>
          <span class="gpu-temp hidden text-xs px-2 py-0.5 rounded-full border border-purple-200 bg-purple-50 text-purple-700"></span>
        </h3>
        <p class="text-xs text-slate-500 mt-0.5"><span class="updated">更新：—</span></p>
      </div>
      <span class="status inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full border border-slate-200 bg-slate-50">
        <span class="dot inline-block w-2 h-2 rounded-full bg-slate-300"></span> 連線中
      </span>
    `;

    const body = document.createElement("div");
    body.className = "p-4 space-y-4";

    // CPU / RAM / Swap
    const sysRow = document.createElement("div");
    sysRow.className = "grid grid-cols-1 sm:grid-cols-3 gap-4";
    sysRow.innerHTML = `
      <div>
        <div class="flex items-center justify-between text-sm mb-1">
          <span class="font-medium">CPU 使用率</span>
          <span class="flex items-center gap-2">
            <span class="cpu-temp hidden text-xs px-2 py-0.5 rounded-full border border-rose-200 bg-rose-50 text-rose-700"></span>
            <span class="mono cpu-text text-slate-700">-</span>
          </span>
        </div>
        <div class="w-full h-2 bg-indigo-100 rounded-full overflow-hidden">
          <div class="bar-cpu h-2 bg-indigo-500 transition-all duration-300" style="width:0%"></div>
        </div>
        <p class="text-xs text-slate-500 mt-1 cpu-core">核心：—</p>
      </div>
      <div>
        <div class="flex items-center justify-between text-sm mb-1">
          <span class="font-medium">RAM 使用率</span>
          <span class="mono ram-text text-slate-700">-</span>
        </div>
        <div class="w-full h-2 bg-emerald-100 rounded-full overflow-hidden">
          <div class="bar-ram h-2 bg-emerald-500 transition-all duration-300" style="width:0%"></div>
        </div>
        <p class="text-xs text-slate-500 mt-1 ram-detail">—</p>
      </div>
      <div>
        <div class="flex items-center justify-between text-sm mb-1">
          <span class="font-medium">Swap 使用率</span>
          <span class="mono swap-text text-slate-700">-</span>
        </div>
        <div class="w-full h-2 bg-amber-100 rounded-full overflow-hidden">
          <div class="bar-swap h-2 bg-amber-500 transition-all duration-300" style="width:0%"></div>
        </div>
        <p class="text-xs text-slate-500 mt-1 swap-detail">—</p>
      </div>
    `;

    // 磁碟表
    const diskWrap = document.createElement("div");
    diskWrap.className = "rounded-xl border border-slate-200 divide-y divide-slate-200";
    diskWrap.innerHTML = `
      <div class="p-3 text-sm font-medium text-slate-700">磁碟 I/O（每秒）</div>
      <div class="p-3">
        <div class="hidden sm:block overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="bg-slate-50 text-slate-700">
                <th class="px-3 py-2 text-left font-semibold">裝置</th>
                <th class="px-3 py-2 text-left font-semibold">Temp (°C)</th>
                <th class="px-3 py-2 text-left font-semibold">Read (MB/s)</th>
                <th class="px-3 py-2 text-left font-semibold">Write (MB/s)</th>
                <th class="px-3 py-2 text-left font-semibold">Read IOPS</th>
                <th class="px-3 py-2 text-left font-semibold">Write IOPS</th>
              </tr>
            </thead>
            <tbody class="disk-tbody divide-y divide-slate-100"></tbody>
          </table>
        </div>
        <div class="sm:hidden space-y-2 disk-list"></div>
      </div>
    `;

    // 網路表
    const netWrap = document.createElement("div");
    netWrap.className = "rounded-xl border border-slate-200 divide-y divide-slate-200";
    netWrap.innerHTML = `
      <div class="p-3 text-sm font-medium text-slate-700 flex items-center justify-between">
        <span>網路 I/O（每秒）</span>
        <button class="net-toggle text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 transition-colors">展開詳細</button>
      </div>
      <div class="p-3">
        <div class="text-sm text-slate-700 mb-3">
          <div class="flex items-center gap-4">
            <span class="font-medium">總合：</span>
            <span class="mono total-rx">RX — MB/s</span>
            <span class="mono total-tx">TX — MB/s</span>
          </div>
        </div>
        <div class="net-details hidden">
          <div class="hidden sm:block overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="bg-slate-50 text-slate-700">
                  <th class="px-3 py-2 text-left font-semibold">介面</th>
                  <th class="px-3 py-2 text-left font-semibold">RX (MB/s)</th>
                  <th class="px-3 py-2 text-left font-semibold">TX (MB/s)</th>
                </tr>
              </thead>
              <tbody class="nic-tbody divide-y divide-slate-100"></tbody>
            </table>
          </div>
          <div class="sm:hidden space-y-2 nic-list"></div>
        </div>
      </div>
    `;

    header.querySelector(".host").textContent = host;

    // 只宣告一次，之後直接賦值
    ui = {
      card,
      // header
      updated: header.querySelector(".updated"),
      status: header.querySelector(".status"),
      dot: header.querySelector(".dot"),
      gpuBadge: header.querySelector(".gpu-temp"),
      // sys
      barCpu: sysRow.querySelector(".bar-cpu"),
      cpuText: sysRow.querySelector(".cpu-text"),
      cpuCore: sysRow.querySelector(".cpu-core"),
      cpuTemp: sysRow.querySelector(".cpu-temp"),
      barRam: sysRow.querySelector(".bar-ram"),
      ramText: sysRow.querySelector(".ram-text"),
      ramDetail: sysRow.querySelector(".ram-detail"),
      barSwap: sysRow.querySelector(".bar-swap"),
      swapText: sysRow.querySelector(".swap-text"),
      swapDetail: sysRow.querySelector(".swap-detail"),
      // disks
      diskTbody: diskWrap.querySelector(".disk-tbody"),
      diskList:  diskWrap.querySelector(".disk-list"),
      // network
      nicTbody:  netWrap.querySelector(".nic-tbody"),
      nicList:   netWrap.querySelector(".nic-list"),
      totalRx:   netWrap.querySelector(".total-rx"),
      totalTx:   netWrap.querySelector(".total-tx"),
      netToggle: netWrap.querySelector(".net-toggle"),
      netDetails: netWrap.querySelector(".net-details"),
    };

    // 網路詳細介面展開/收合
    ui.netToggle.addEventListener("click", () => {
      const isHidden = ui.netDetails.classList.contains("hidden");
      if (isHidden) {
        ui.netDetails.classList.remove("hidden");
        ui.netToggle.textContent = "收合詳細";
      } else {
        ui.netDetails.classList.add("hidden");
        ui.netToggle.textContent = "展開詳細";
      }
    });

    card.append(header, body);
    body.append(sysRow, diskWrap, netWrap);
    grid.appendChild(card);
    cards.set(host, ui);
    return ui;
  }
    // ===== 收訊：先快取，再批次渲染 =====
    client.on("message", (topic, payload) => {
      try {
        const data = JSON.parse(payload.toString());
        const host = data.host || topic.split("/")[2] || "unknown";
        latestByHost.set(host, data);
        scheduleRender();
      } catch(e) {
        console.warn("bad JSON", e);
      }
    });

    let renderScheduled = false;
    function scheduleRender(){
      if (renderScheduled) return;
      renderScheduled = true;
      // 用 rAF + setTimeout 雙保險，避免背景分頁掉幀
      const doRender = () => {
        renderScheduled = false;
        try { flushRender(); } catch(e){ console.error("render error:", e); }
      };
      if ("requestAnimationFrame" in window){
        requestAnimationFrame(()=> setTimeout(doRender, 0));
      }else{
        setTimeout(doRender, 0);
      }
    }

    function flushRender(){
      const now = Date.now();
      latestByHost.forEach((data, host) => {
        const ui = ensureCard(host);
        try {
          updateCard(ui, data, now);
        } catch(e){
          // 即使單張卡片出錯，也不影響其他卡片更新
          console.error(`update ${host} failed`, e);
        }
      });
    }

    // ===== 更新單張卡片 =====
    function updateCard(ui, data, nowMs){
      const ts = safe(() => new Date((data.ts ?? (nowMs/1000))*1000), new Date());
      ui.updated.textContent = "更新：" + ts.toLocaleTimeString();

      // 狀態燈
      const fresh = (nowMs - ts.getTime() < 5000);
      ui.dot.className = "dot inline-block w-2 h-2 rounded-full " + (fresh ? "bg-emerald-500" : "bg-amber-500");
      ui.status.className = "status inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full border " +
        (fresh ? "border-emerald-200 bg-emerald-50 text-emerald-700" : "border-amber-200 bg-amber-50 text-amber-700");
      ui.status.lastChild && (ui.status.lastChild.nodeType===3) ? (ui.status.lastChild.nodeValue = fresh ? " 即時" : " 延遲") : null;

      // CPU / RAM / Swap
      const cpu = data.cpu || {};
      const mem = data.memory || {};
      const total = num(cpu.percent_total);
      const cores = Array.isArray(cpu.percent_per_core) ? cpu.percent_per_core.length : (cpu.count_logical ?? "-");
      ui.cpuCore.textContent = `核心：${cores}（實體：${cpu.count_physical ?? "-" }）`;
      ui.barCpu.style.width = isNaN(total) ? "0%" : `${clamp(total,0,100).toFixed(1)}%`;
      ui.cpuText.textContent = isNaN(total) ? "-" : `${total.toFixed(1)}%`;

      // RAM
      const ramPct = num(mem.ram && mem.ram.percent);
      const ramUsed = num(mem.ram && mem.ram.used);
      const ramTotal = num(mem.ram && mem.ram.total);
      ui.barRam.style.width = isNaN(ramPct) ? "0%" : `${clamp(ramPct,0,100).toFixed(1)}%`;
      ui.ramText.textContent = isNaN(ramPct) ? "-" : `${ramPct.toFixed(1)}%`;
      ui.ramDetail.textContent = (!isNaN(ramUsed) && !isNaN(ramTotal))
        ? `${(ramUsed/1024/1024/1024).toFixed(1)} / ${(ramTotal/1024/1024/1024).toFixed(1)} GB`
        : "—";

      // Swap
      const swapPct = num(mem.swap && mem.swap.percent);
      const swapUsed = num(mem.swap && mem.swap.used);
      const swapTotal = num(mem.swap && mem.swap.total);
      ui.barSwap.style.width = isNaN(swapPct) ? "0%" : `${clamp(swapPct,0,100).toFixed(1)}%`;
      ui.swapText.textContent = isNaN(swapPct) ? "-" : `${swapPct.toFixed(1)}%`;
      ui.swapDetail.textContent = (!isNaN(swapUsed) && !isNaN(swapTotal))
        ? `${(swapUsed/1024/1024/1024).toFixed(1)} / ${(swapTotal/1024/1024/1024).toFixed(1)} GB`
        : "—";

      // CPU 溫度 + GPU 溫度
      const temps = data.temperatures || null;
      const cpuNow = pickCpuTemp(temps);
      if (isFinite(cpuNow)) { ui.cpuTemp.textContent = `CPU ${cpuNow.toFixed(1)}°C`; ui.cpuTemp.classList.remove("hidden"); }
      else { ui.cpuTemp.classList.add("hidden"); }

      const gpuNow = pickGpuTemp(temps);
      if (isFinite(gpuNow)) { ui.gpuBadge.textContent = `GPU ${gpuNow.toFixed(1)}°C`; ui.gpuBadge.classList.remove("hidden"); }
      else { ui.gpuBadge.classList.add("hidden"); }

      // 磁碟
      renderDisks(ui, data.disk_io || {}, temps);
      // 網路
      renderNetwork(ui, data.network_io || { per_nic:{}, total:{rate:{}, cumulative:{}} });
    }

    // === 磁碟（含對應溫度）===
    function renderDisks(ui, diskIO, temps){
      const devs = Object.keys(diskIO).sort((a,b)=>a.localeCompare(b, 'en', {numeric:true}));
      // 桌機
      ui.diskTbody.innerHTML = devs.map(dev => {
        const r = safe(() => diskIO[dev].rate, {});
        const t = pickDiskTemp(dev, temps);
        return `
          <tr>
            <td class="px-3 py-2 font-medium mono">${escapeHTML(dev)}</td>
            <td class="px-3 py-2">${fmtTemp(t)}</td>
            <td class="px-3 py-2">${fmtMB(toMB(r.read_bytes_per_s))}</td>
            <td class="px-3 py-2">${fmtMB(toMB(r.write_bytes_per_s))}</td>
            <td class="px-3 py-2">${fmtNum(r.read_iops)}</td>
            <td class="px-3 py-2">${fmtNum(r.write_iops)}</td>
          </tr>
        `;
      }).join("") || `<tr><td class="px-3 py-2" colspan="6">（無資料）</td></tr>`;

      // 手機
      ui.diskList.innerHTML = devs.map(dev => {
        const r = safe(() => diskIO[dev].rate, {});
        const t = pickDiskTemp(dev, temps);
        return `
          <div class="rounded-lg border border-slate-200 p-3">
            <div class="flex items-center justify-between">
              <span class="font-medium mono">${escapeHTML(dev)}</span>
              <span class="text-xs px-2 py-0.5 rounded-full border ${badgeTempColor(t)}">${fmtTemp(t)}</span>
            </div>
            <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
              <div>Read：<span class="mono">${fmtMB(toMB(r.read_bytes_per_s))}</span> MB/s</div>
              <div>Write：<span class="mono">${fmtMB(toMB(r.write_bytes_per_s))}</span> MB/s</div>
              <div>R-IOPS：<span class="mono">${fmtNum(r.read_iops)}</span></div>
              <div>W-IOPS：<span class="mono">${fmtNum(r.write_iops)}</span></div>
            </div>
          </div>
        `;
      }).join("") || `<div class="text-sm text-slate-500">（無資料）</div>`;
    }

    // === 網路 ===
    function renderNetwork(ui, net){
      const tr = safe(()=>net.total.rate.rx_bytes_per_s, NaN);
      const tt = safe(()=>net.total.rate.tx_bytes_per_s, NaN);
      ui.totalRx.textContent  = `RX ${fmtMB(toMB(tr))} MB/s`;
      ui.totalTx.textContent  = `TX ${fmtMB(toMB(tt))} MB/s`;

      const nics = Object.keys(net.per_nic || {}).sort();
      ui.nicTbody.innerHTML = nics.map(n => {
        const r = safe(()=> net.per_nic[n].rate, {});
        return `
          <tr>
            <td class="px-3 py-2 font-medium mono">${escapeHTML(n)}</td>
            <td class="px-3 py-2">${fmtMB(toMB(r.rx_bytes_per_s))}</td>
            <td class="px-3 py-2">${fmtMB(toMB(r.tx_bytes_per_s))}</td>
          </tr>
        `;
      }).join("") || `<tr><td class="px-3 py-2" colspan="3">（無資料）</td></tr>`;

      ui.nicList.innerHTML = nics.map(n => {
        const r = safe(()=> net.per_nic[n].rate, {});
        return `
          <div class="rounded-lg border border-slate-200 p-3">
            <div class="flex items-center justify-between">
              <span class="font-medium mono">${escapeHTML(n)}</span>
            </div>
            <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
              <div>RX：<span class="mono">${fmtMB(toMB(r.rx_bytes_per_s))}</span> MB/s</div>
              <div>TX：<span class="mono">${fmtMB(toMB(r.tx_bytes_per_s))}</span> MB/s</div>
            </div>
          </div>
        `;
      }).join("") || `<div class="text-sm text-slate-500">（無資料）</div>`;
    }

    // ===== 溫度抽取（前端顯示） =====
    function pickCpuTemp(temps){
      if(!temps) return NaN;
      const srcs = [];
      if (temps.k10temp)  srcs.push(...temps.k10temp);
      if (temps.coretemp) srcs.push(...temps.coretemp);
      let max = NaN;
      for(const t of srcs){
        const v = Number(t.current);
        if(isFinite(v)) max = isNaN(max) ? v : Math.max(max, v);
      }
      return max;
    }
    function pickGpuTemp(temps){
      if(!temps || !temps.amdgpu) return NaN;
      let max = NaN;
      for(const t of temps.amdgpu){
        const v = Number(t.current);
        if(isFinite(v)) max = isNaN(max) ? v : Math.max(max, v);
      }
      return max;
    }
    function pickDiskTemp(dev, temps){
      if(!temps) return NaN;
      if (temps[dev] && Array.isArray(temps[dev]) && temps[dev].length){
        const v = Number(temps[dev][0].current);
        if (isFinite(v)) return v;
      }
      if (dev.startsWith("nvme") && temps.nvme && temps.nvme.length){
        const v = Number(temps.nvme[0].current);
        if (isFinite(v)) return v;
      }
      return NaN;
    }
    function badgeTempColor(v){
      const n = Number(v);
      if (!isFinite(n)) return "border-slate-200 bg-slate-50 text-slate-600";
      if (n < 50)  return "border-emerald-200 bg-emerald-50 text-emerald-700";
      if (n < 60)  return "border-amber-200 bg-amber-50 text-amber-700";
      return "border-rose-200 bg-rose-50 text-rose-700";
    }

    // ===== helpers =====
    function safe(fn, fallback = undefined){ try{ return fn(); }catch{ return fallback; } }
    function num(v){ const n = Number(v); return isFinite(n) ? n : NaN; }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function toMB(bps){ const n = num(bps); return isNaN(n) ? NaN : (n/1024/1024); }
    function fmtMB(v){ return isNaN(v) ? "-" : v.toFixed(3); }
    function fmtNum(v){ const n = num(v); return isNaN(n) ? "-" : n.toFixed(2); }
    function fmtTemp(v){ const n = num(v); return isNaN(n) ? "-" : n.toFixed(1); }
    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>
</body>
</html>
